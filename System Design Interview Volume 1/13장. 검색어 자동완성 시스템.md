## 문제 이해 및 설계 범위 확정
- 설계 분석
	- 자동완성 범위
	- 최소 표시 갯수
	- 선택 기준
	- 맞춤법 검사 지원 여부
	- 언어
	- DAU
### 요구사항
- 빠른 응답 속도
	- 사용자 입력에 대한 즉각 피드백
	- 페이스북은 100밀리초 이내로 구현
- 연관성
	- 사용자 입력 단어와 연관성은 필수임
- 정렬
	- 순위 모델(인기도 등...)에 의한 정렬
- 규모 확장성
- 고가용성
## 개략적 설계안 제시 및 동의 구하기
- **[[#데이터 수집 서비스]]**: 사용자가 입력한 질의를 실시간으로 수집하는 시스템
- **[[#질의 서비스]]**: 주어진 질의에 n개의 인기 검색어를 정렬해 내놓는 서비스
### 데이터 수집 서비스
- 질의 문과 사용 빈도를 저장하는 빈도 테이블 구현
- 질의에 따른 빈도 갯수 증가

### 질의 서비스
- 빈도 테이블이 존재한다고 가정했을 때 빈도 갯수를 활용해 검색어 반환
## 상세 설계
- 관계형 데이터베이스 쿼리를 활용하는 방식은 효율적이지 않음
- [[#Trie|트라이(Trie)]] 자료구조를 이용한 구현

### Trie
![](https://upload.wikimedia.org/wikipedia/commons/thumb/b/be/Trie_example.svg/500px-Trie_example.svg.png)
- 문자열을 간략하게 저장할 수 있는 자료구조
	- 문자열을 꺼내는 연산에 초점을 맞춰 구현
	- Tree 형태의 자료구조
	- 각 노드는 character 한 개를 저장하고 26개(알파벳 개수)의 자식 노드를 가질 수 있음
	- 각 노드는 하나의 단어 또는 prefix를 나타냄
- 접두어 노드 탐색 → 하위 트리 탐색을 통한 모든 유효 노드 조회 → 빈도 수에 의한 정렬 후 상위 반환
	- 시간복잡도: `O(p) + O(c) + O(c log c)`
		- `p`: prefix 길이, `c`: 주어진 노드의 자식 노드 갯수
	- 최악의 경우 전체 트라이를 다 뒤져야 함
		- [[#접두어 최대 길이 제한]], [[#노드에 인기 검색어 캐시]] 방법으로 해결 가능
#### 접두어 최대 길이 제한
- 사용자가 검색을 매우 길게 하는 경우는 X
	- 접두어 최대 길이를 50으로 가정하면 `O(p) → O(1)`
#### 노드에 인기 검색어 캐시
- 각 노드에 인기 검색어를 캐싱해두어 하위 노드 검색을 방지
- 검색 속도는 향상되나 메모리 공간이 많이 필요하다는 단점
### 데이터 수집 서비스
- 실시간으로 트라이를 갱신하는 것은 현실적으로 불가능
- 인기 검색어는 자주 바뀌지 않을 것임 → 자주 갱신할 필요가 없음
#### 데이터 분석 서비스 로그
- 검색창에 입력된 질의에 관한 원본 데이터 보관
- 수정은 이루어지지 않고 추가만 이루어짐 → 데이터에 대한 인덱싱을 고려하지 않음
#### 로그 취합 서버
- 많은 양의 로그를 잘 취합해 시스템에 적합한 형태로 가공
- 시스템의 특성에 따른 적절한 취합 주기 고려 필요
	- 실시간성이 고려된다면 짧게 아니라면 길게
#### 작업 서버
- 주기적으로 비동기 작업을 실행하는 서버 집합
- 트라이 자료구조를 만들고 DB에 저장하는 역할
#### 트라이 캐시
- 분산 캐시 시스템
- 트라이 데이터를 메모리에 유지해 읽기 성능 향상
- 스냅샷 활용 갱신
#### 트라이 데이터베이스
- 지속성 저장소
	- document, key-value store 중 고려 필요
### 질의 서비스
- 동작 과정
	1. 검색 질의가 로드밸런싱 후 API 서버로 전달
	2. 트라이 캐시 데이터 활용 자동완성 검색어 제안 응답 구성
	3. 캐시가 존재하지 않는 경우 DB 조회 후 캐시 채우기
- 성능 개선을 위한 고려
	- AJAX
		- 페이지 새로고침 없이 자동완성된 검색어 목록 조회
	- 브라우저 캐싱
		- 브라우저 캐시를 활용해 자동 완성 검색어 제안 결과를 계속 요청하지 않도록 함
			- 구글 검색 엔진 활용 방식
	- 데이터 샘플링
		- 모든 요청을 로깅하는 것이 아닌 샘플만 로깅
### 트라이 연산
#### 트라이 생성
- [[#작업 서버]]를 통해 생성됨
- [[#데이터 분석 서비스 로그]]나 DB 데이터 이용
#### 트라이 갱신
- 매주 갱신 → 새로운 트라이 생성 후 기존 트라이 대체
- 각 노드 개별 갱신 → 성능상의 약점이 존재함
#### 검색어 삭제
- 혐오, 폭력적, 성적, 위험 표현 삭제 필요
- 트라이 캐시 앞에 필터 계층을 두어 부적절한 질의어 반환을 막기

### 저장소 규모 확장
- 첫 글자 기준 샤딩
- 과거 질의 데이터 패턴 기반 샤딩 → 샤드 관리자 구현 필요
## 마무리
- 추가로 논의하면 좋을 것
	- 다국어 지원을 위한 확장 → 유니코드 고려
	- 국가별 인기 검색어 순위 관리
	- 실시간성 반영

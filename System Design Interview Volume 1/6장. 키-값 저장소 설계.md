- **키-값 저장소(key-value store)**
	- 비 관계형 데이터베이스
	- 값을 저장하기 위해서 고유 식별자인 키를 가져야 함 → key-value pair
	- 키는 유일해야 하고 값은 키를 통해서만 접근 가능
## 문제 이해 및 설계 범위 확정
- **읽기**, **쓰기**, **메모리 사용량** 사이의 균형을 찾고 **데이터 일관성과 가용성 사이에서** 타협적 결정을 내려야 함
## 단일 서버 키-값 저장소
- 키-값 쌍 전부를 메모리에 해시 테이블로 저장
	- 모든 데이터를 메모리 안에 두는 것이 불가능하다는 약점
- 데이터 압축이나 자주 사용하지 않는 데이터는 디스크에 저장하는 방법 고려 가능
- 많은 데이터 저장을 위한 **[[#분산 키-값 저장소]]** 필요
## 분산 키-값 저장소
### CAP 정리
- **데이터 일관성**, **가용성**, **파티션 감내**를 동시에 만족하는 분산 시스템을 설계하는 것은 불가능
	- **데이터 일관성(Consistency)**: 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속해도 언제나 같은 데이터를 봄
	- **가용성(Availability)**: 시스템에 일부 노드에 장애가 발생해도 항상 응답을 보내야함
	- **파티션 감내(Partition Tolerance)**: 네트워크에 파티션이 생기더라도 시스템은 계속 동작
		- 파티션: 두 노드 사이에 통신 장애가 발생
![](https://upload.wikimedia.org/wikipedia/commons/c/c6/CAP_Theorem_Venn_Diagram.png)
- **CP 시스템**: 가용성을 희생해 일관성과 파티션 감내를 지원
	- 장애 발생시 데이터 불일치 문제를 피하기 위해 쓰기 연산 중단
- **AP 시스템**: 데이터 일관성을 희생해 가용성과 파티션 감내를 지원
	- 장애 발생시에도 읽기 연산 허용
- **CA 시스템**: 일관성과 가용성만 지원 → **실세계에 존재하지 않음**
	- 통상 네트워크 장애는 피할 수 없는 일 → 반드시 파티션 문제를 감내할 수 있도록 설계해야함

### 시스템 컴포넌트
#### 데이터 파티션
- 전체 데이터를 작은 파티션들로 분할한 후 여러 대 서버에 저장
	- **데이터를 여러 서버에 고르게 분산할 수 있는가**
	- **노드가 추가되거나 삭제될 때 데이터의 이동을 최소화 할 수 있는가**
- [[5장. 안정 해시 설계|안정 해시]]를 활용해 문제 해결 가능
	- Automatic Scaling
	- Heterogeneity: 서버의 용량에 맞게 가상 노드 수 조정
#### 데이터 다중화
- 높은 가용성과 안정성 확보를 위해 데이터를 **N개 서버에 비동기적으로 다중화(Replication)해야함**
	- 해시 링을 순회하면서 만나는 첫 N개 서버에 데이터 사본 보관 → 같은 물리 서버를 중복 선택하지 않도록 해야함
#### 데이터 일관성
- 동기화를 위한 **정족수 합의 프로토콜** 사용
	- `N`: 사본 개수, `W`: 쓰기 연산에 대한 정족수, `R`: 읽기 연산에 대한 정족수
- 중재자가 서버로부터 요청에 대해 정족수를 만족하는 응답을 받으면 다른 응답을 기다릴 필요 없이 반환 → 프록시 역할
- `W + R > N` 인 경우 **강한 일관성** 보장
- 가능한 구성
	- `R = 1, W = N`: 빠른 읽기 연산에 최적화된 시스템
	- `W = 1, R = N`: 빠른 쓰기 연산에 최적화 된 시스템
	- `W + R > N`: 강한 일관성 보장
	- `W + R <= N`: 강한 일관성 보장 X
#### 일관성 모델
- 데이터의 일관성 수준 결정
- **강한 일관성**: 모든 읽기 연산은 **가장 최근에 갱신된 결과** 반환
	- 모든 사본에 현재 쓰기 연산의 결과가 반영될 때까지 해당 데이터에 대해 Lock
	- 고가용성 시스템에 부적합 → 새로운 요청 처리가 중단됨
- **약한 일관성**: 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있음
- **결과적 일관성**: 약한 일관성의 한 형태, 갱신 결과가 결국에는 모든 사본에 반영
	- 쓰기 연산 병렬 발생에 의한 일관성이 깨짐
	- 클라이언트에서 데이터 버전 정보를 활용해 문제 해결
#### 비 일관성 해소 기법: 데이터 버저닝
- 버저닝: 데이터를 변경할 때마다 해당 데이터의 새로운 버전 생성
	- 새로운 버전 생성이 동시에 되는 경우는? → **벡터 시계(Vector clock) 활용**
- **Vector Clock**: `[Server, Version]` 순서쌍을 데이터에 매단 것
	- `D([S1, v1], [S2, v2], ..., [Sn, Vn])`으로 표현
	- `D`: 데이터, `vi`: 버전 카운터, `Si`: 서버 번호
	- 데이터 `D`를 서버 `Si`에 기록할 때
		- `[Si, vi]`가 있으면 `vi` 증가
		- 없다면 `[Si, 1]` 생성
- 모든 구성 요소의 값이 다른 데이터에 포함된 모든 구성요소의 값보다 같거나 크면 새로운 버전의 데이터
- 단점
	- 충돌 감지 및 해소 로직이 클라이언트에 들어가 클라이언트 구현이 복잡해 짐
	- `[Server: Version]` 순서 쌍의 개수가 굉장히 빠르게 증가 → Threshold를 설정해 오래된 순서쌍 제거
#### 장애 감지
- 모든 노드 사이에 멀티캐스팅 채널을 구축하기 → 쉽지만 서버가 많아지면 비효율
- **가십 프로토콜**같은 분산형 장애 감지 솔루션이 효율적임
	- 각 노드는 주기적으로 임의의 다른 노드와 통신해 자신의 정보 공유
	- 어떤 노드의 박동 카운터 값이 갱신되지 않으면 장애 상태인 것으로 간주
#### 일시적 장애 처리
- **엄격한 정족수** 접근법을 사용하면 읽기, 쓰기 연산 금지해야함
- **느슨한 정족수** 접근법으로 조건을 완화해 가용성을 높임
	- 정족수 요구사항을 강제하는 대신, 쓰기 연산을 수행할 W개의 건강한 서버와 읽기 연산을 수행할 R개의 건강한 서버 선택
	- 시스템 일부 노드의 일관성은 보장되지 않음 → **최종 일관성 지향**

| 특징       | 엄격한 정족수 | 느슨한 정족수 |
| :------- | :-----: | :-----: |
| 일관성      | 강한 일관성  | 최종 일관성  |
| 가용성      |   낮음    |   높음    |
| 성능       |   느림    |   빠름    |
| 복구 후 자동화 |   불필요   | 동기화 필요  |
#### 영구 장애 처리
- 영구 장애 처리를 위해 **반-엔트로피 프로토콜**을 구현해 사본 동기화 → **머클 트리 활용**
	- **머클 트리**: 데이터를 블록 형태로 저장하고, 각 블록의 해시 값을 계층적으로 연결해 데이터 무결성 검증
	```mermaid
	graph TD
	    A[Data Block A] --> HA[Hash A]
	    B[Data Block B] --> HB[Hash B]
	    C[Data Block C] --> HC[Hash C]
	    D[Data Block D] --> HD[Hash D]

	    HA --> HAB[Hash AB]	
	    HB --> HAB
	    HC --> HCD[Hash CD]
	    HD --> HCD	  
	
	    HAB --> Root[Root Hash]
	    HCD --> Root
	```

#### 데이터 센터 장애 처리
- 데이터 센터 다중화를 통해 대응

## 요약

| 목표/문제               | 기술                                      |
| :------------------ | :-------------------------------------- |
| 대규모 데이터 저장          | [[5장. 안정 해시 설계\|안정 해시]]를 사용해 서버들에 부하 분산 |
| 읽기 연산에 대한 높은 가용성 보장 | 데이터를 여러 데이터센터에 다중화                      |
| 쓰기 연산에 대한 높은 가용성 보장 | 버저닝 및 벡터 시계를 사용한 충돌 해소                  |
| 데이터 파티션             | [[5장. 안정 해시 설계\|안정 해시]]                 |
| 점진적 규모 확장성          | [[5장. 안정 해시 설계\|안정 해시]]                 |
| 다양성(Heterogeneity)  | [[5장. 안정 해시 설계\|안정 해시]]                 |
| 조절 가능한 데이터 일관성      | 정족수 합의                                  |
| 일시적 장애 처리           | 느슨한 정족수 프로토콜과 단서 후 임시 위탁                |
| 영구적 장애 처리           | 머클 트리                                   |
| 데이터 센터 장애 대응        | 여러 데이터 센터에 걸친 데이터 다중화                   |
